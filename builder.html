<!DOCTYPE html>
<html>
<head>
    <title>Character Builder</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="config.js"></script>
    <script src="game_rules.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #121212; color: #eee; margin: 0; padding: 20px; display: flex; justify-content: center; min-height: 100vh; }
        .builder-container { max-width: 650px; width: 100%; background: #1e1e1e; padding: 30px; border-radius: 8px; border: 1px solid #333; display: flex; flex-direction: column; }
        h1 { color: #e51e25; border-bottom: 1px solid #333; padding-bottom: 10px; margin-top: 0; text-align: center; }
        .step { display: none; animation: fadeIn 0.3s; }
        .step.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        label { display: block; color: #8af; font-weight: bold; margin-bottom: 5px; margin-top: 15px; font-size: 0.9em; }
        input, select, textarea { width: 100%; padding: 12px; background: #2a2a2a; border: 1px solid #444; color: white; border-radius: 4px; box-sizing: border-box; font-size: 1em; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }
        .stat-box { text-align: center; background: #252525; padding: 10px; border-radius: 4px; border: 1px solid #333; }
        .bonus-badge { font-size: 0.8em; color: #4f4; display: block; height: 1.2em; margin-top: 5px; }
        .nav-btns { margin-top: auto; padding-top: 20px; display: flex; justify-content: space-between; border-top: 1px solid #333; }
        .btn { padding: 12px 25px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-next { background: #e51e25; color: white; }
        .btn-prev { background: #444; color: white; }
    </style>
</head>
<body>

<div class="builder-container">
    <h1 id="headerTitle">Basic Info</h1>
    
    <div id="step1" class="step active">
        <label>Character Name</label><input type="text" id="charName">
        <label>Race</label><select id="charRace" onchange="updateRaceInfo()"></select><div id="raceSummary" style="color:#aaa; font-size:0.8em;"></div>
        <label>Class</label><select id="charClass" onchange="updateClassInfo()"></select><div id="classSummary" style="color:#aaa; font-size:0.8em;"></div>
    </div>

    <div id="step2" class="step">
        <div style="text-align:center; color:#888;">Standard Array: 15, 14, 13, 12, 10, 8</div>
        <div class="stat-grid">
            <div class="stat-box"><label>STR</label><select id="base_STR" onchange="updateStatOptions()"></select><span id="bon_STR" class="bonus-badge"></span></div>
            <div class="stat-box"><label>DEX</label><select id="base_DEX" onchange="updateStatOptions()"></select><span id="bon_DEX" class="bonus-badge"></span></div>
            <div class="stat-box"><label>CON</label><select id="base_CON" onchange="updateStatOptions()"></select><span id="bon_CON" class="bonus-badge"></span></div>
            <div class="stat-box"><label>INT</label><select id="base_INT" onchange="updateStatOptions()"></select><span id="bon_INT" class="bonus-badge"></span></div>
            <div class="stat-box"><label>WIS</label><select id="base_WIS" onchange="updateStatOptions()"></select><span id="bon_WIS" class="bonus-badge"></span></div>
            <div class="stat-box"><label>CHA</label><select id="base_CHA" onchange="updateStatOptions()"></select><span id="bon_CHA" class="bonus-badge"></span></div>
        </div>
        <div style="text-align:center; margin-top:20px;">Starting HP: <span id="calcHP" style="color:#4f4; font-weight:bold;"></span></div>
    </div>

    <div id="step3" class="step">
        <label>Skills</label>
        <div id="racialSkillsArea"></div>
        <div id="skillSelectArea"></div>
    </div>

    <div id="step4" class="step">
        <label>Roleplay</label>
        <input type="text" id="charAlign" placeholder="Alignment">
        <textarea id="charBack" placeholder="Backstory" rows="3"></textarea>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <input type="text" id="rpEyes" placeholder="Eyes">
            <input type="text" id="rpHair" placeholder="Hair">
        </div>
    </div>

    <div class="nav-btns">
        <button class="btn btn-prev" onclick="changeStep(-1)" id="btnPrev" style="visibility:hidden;">Back</button>
        <button class="btn btn-next" onclick="changeStep(1)" id="btnNext">Next</button>
    </div>
</div>

<script>
    const params = new URLSearchParams(window.location.search);
    const ROOM_ID = params.get('room');
    const EDIT_ID = params.get('id');
    if(!ROOM_ID) window.location.href = "index.html";

    let currentStep = 1;
    const STAT_KEYS = ['STR','DEX','CON','INT','WIS','CHA'];
    const STANDARD_ARRAY = [15, 14, 13, 12, 10, 8];

    // INIT
    const raceSel = document.getElementById('charRace');
    Object.keys(RACES).sort().forEach(r => raceSel.add(new Option(r,r)));
    const classSel = document.getElementById('charClass');
    Object.keys(CLASSES).sort().forEach(c => classSel.add(new Option(c,c)));

    STAT_KEYS.forEach((s, i) => {
        let sel = document.getElementById(`base_${s}`);
        sel.add(new Option("--", ""));
        STANDARD_ARRAY.forEach(n => sel.add(new Option(n, n)));
    });

    if (EDIT_ID) {
        document.getElementById('headerTitle').innerText = "Edit Character";
        db.ref(`campaigns/${ROOM_ID}/characters/${EDIT_ID}`).once('value', snap => {
            if(snap.exists()) {
                const c = snap.val();
                document.getElementById('charName').value = c.name;
                raceSel.value = c.race;
                classSel.value = c.class;
                
                // Pre-fill stats if saved, otherwise try to guess or reset
                if (c.base_stats) {
                    STAT_KEYS.forEach(s => document.getElementById(`base_${s}`).value = c.base_stats[s]);
                }
                
                // Pre-fill RP
                document.getElementById('charAlign').value = c.alignment || "";
                document.getElementById('charBack').value = c.backstory || "";
                document.getElementById('rpEyes').value = c.eyes || "";
                document.getElementById('rpHair').value = c.hair || "";
                
                updateRaceInfo(); updateClassInfo(); updateStatOptions();
            }
        });
    } else {
        updateRaceInfo(); updateClassInfo(); updateStatOptions();
    }

    // LOGIC
    function updateStatOptions() {
        STAT_KEYS.forEach(s => {
            let sel = document.getElementById(`base_${s}`);
            let val = parseInt(sel.value);
            // Rebuild
            sel.innerHTML = "";
            sel.add(new Option("--", ""));
            if (!isNaN(val)) sel.add(new Option(val, val, true, true));
            
            STANDARD_ARRAY.forEach(num => {
                let taken = false;
                STAT_KEYS.forEach(k => { if(k!==s && parseInt(document.getElementById(`base_${k}`).value)===num) taken=true; });
                if(!taken && num !== val) sel.add(new Option(num, num));
            });
        });
        calcStats();
    }

    function updateRaceInfo() {
        const r = RACES[raceSel.value];
        let txt = "Bonuses: "; for(let s in r.bonuses) txt+=`${s} +${r.bonuses[s]} `;
        document.getElementById('raceSummary').innerText = txt;
        calcStats();
    }

    function updateClassInfo() {
        const c = CLASSES[classSel.value];
        document.getElementById('classSummary').innerText = `HP: d${c.hit_die} | Saves: ${c.saves.join(', ')}`;
        calcStats();
        renderSkills();
    }

    function calcStats() {
        const rData = RACES[raceSel.value];
        const cData = CLASSES[classSel.value];
        let conTotal = 10;
        STAT_KEYS.forEach(s => {
            let base = parseInt(document.getElementById(`base_${s}`).value)||0;
            let bonus = (rData.bonuses && rData.bonuses[s]) ? rData.bonuses[s] : 0;
            document.getElementById(`bon_${s}`).innerText = bonus>0?`+${bonus}`:"";
            if(s==='CON') conTotal = base+bonus;
        });
        let conMod = Math.floor((conTotal-10)/2);
        document.getElementById('calcHP').innerText = cData.hit_die + conMod + (rData.hp_bonus||0);
    }

    function renderSkills() {
        const c = CLASSES[classSel.value];
        const area = document.getElementById('skillSelectArea');
        area.innerHTML = "";
        let count = c.num_skills || 2;
        if(classSel.value==="Rogue") count=4; if(classSel.value==="Bard"||classSel.value==="Ranger") count=3;
        
        let opts = c.skill_options || Object.keys(SKILLS_LIST);
        for(let i=0; i<count; i++) {
            let sel = document.createElement('select');
            sel.className = "skill-select";
            opts.forEach(sk => sel.add(new Option(sk, sk)));
            area.appendChild(sel);
        }
    }

    function changeStep(dir) {
        document.getElementById(`step${currentStep}`).classList.remove('active');
        currentStep += dir;
        if(currentStep > 4) { save(); return; }
        document.getElementById(`step${currentStep}`).classList.add('active');
        document.getElementById('btnPrev').style.visibility = currentStep>1?'visible':'hidden';
        document.getElementById('btnNext').innerText = currentStep===4 ? (EDIT_ID?'Update':'Create') : 'Next';
    }

    function save() {
        // Collect Data
        let baseStats = {};
        let finalStats = {};
        STAT_KEYS.forEach(s => {
            let b = parseInt(document.getElementById(`base_${s}`).value)||10;
            let bon = (RACES[raceSel.value].bonuses[s]||0);
            baseStats[s] = b;
            finalStats[s] = b + bon;
        });
        
        let conMod = Math.floor((finalStats['CON']-10)/2);
        let hp = CLASSES[classSel.value].hit_die + conMod + (RACES[raceSel.value].hp_bonus||0);
        
        let skills = [];
        document.querySelectorAll('.skill-select').forEach(s => skills.push(s.value));
        
        // Simplified Save (Merges with existing if editing)
        let data = {
            name: document.getElementById('charName').value,
            race: raceSel.value,
            class: classSel.value,
            base_stats: baseStats,
            stats: finalStats,
            hp_max: hp,
            alignment: document.getElementById('charAlign').value,
            backstory: document.getElementById('charBack').value,
            eyes: document.getElementById('rpEyes').value,
            hair: document.getElementById('rpHair').value,
            skills: skills
        };
        
        if(!EDIT_ID) {
            // New Char Defaults
            data.hp_curr = hp;
            data.inventory = [...(CLASSES[classSel.value].items||[]), "Rations"];
            data.coins = {gp: 10};
        }

        const ref = EDIT_ID ? db.ref(`campaigns/${ROOM_ID}/characters/${EDIT_ID}`) : db.ref(`campaigns/${ROOM_ID}/characters`).push();
        
        (EDIT_ID ? ref.update(data) : ref.set(data)).then(() => {
            window.location.href = `sheet.html?room=${ROOM_ID}&id=${ref.key || EDIT_ID}`;
        });
    }
</script>
</body>
</html>
