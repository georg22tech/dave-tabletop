<!DOCTYPE html>
<html>
<head>
    <title>Character Sheet</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="config.js"></script>
    <script src="game_rules.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #1a1a1a; color: #eee; margin: 0; padding: 20px; display:flex; flex-direction:column; height:100vh; box-sizing:border-box;}
        
        /* HEADER */
        header { background: #252525; padding: 15px 20px; border-bottom: 2px solid #444; display:flex; justify-content:space-between; align-items:center; box-shadow: 0 4px 6px rgba(0,0,0,0.3); z-index: 10; flex-shrink: 0; }
        .char-identity h1 { margin:0; color: #fff; font-size: 1.6em; line-height: 1em; }
        .char-identity .sub { color: #8af; font-size: 0.8em; font-weight: bold; }
        
        .combat-stats { display: flex; align-items: center; gap: 15px; }
        .stat-badge { text-align:center; border:2px solid #555; border-radius: 8px; width:70px; background:#333; height: 60px; display:flex; flex-direction:column; justify-content:center; position:relative;}
        .stat-val { font-size:1.4em; font-weight:bold; color:#fff; line-height: 1em; }
        .stat-label { font-size:0.65em; color:#aaa; text-transform: uppercase; letter-spacing: 1px; }
        .hp-box { border-color: #4f4; }
        .hp-input { background:transparent; border:none; color:#4f4; font-size:1em; font-weight:bold; width:100%; text-align:center; cursor:pointer; }
        .init-box { border-color: #e51e25; cursor: pointer; transition: 0.2s; }
        .init-box:hover { background: #444; box-shadow: 0 0 8px #e51e25; }
        .init-box .stat-val { color: #e51e25; }

        .rest-group { display: flex; flex-direction: column; gap: 3px; }
        .btn-rest { border: none; padding: 4px 10px; border-radius: 4px; font-weight: bold; cursor: pointer; color: white; font-size: 0.75em; text-transform: uppercase; }
        .btn-rest.short { background: #d4af37; color: #111; } 
        .btn-rest.long { background: #2a7a3a; }
        
        /* TABS */
        .tab-nav { display: flex; background: #1f1f1f; border-bottom: 1px solid #444; flex-shrink: 0; }
        .tab-btn { flex: 1; background: transparent; border: none; color: #888; padding: 15px; font-size: 1em; cursor: pointer; font-weight: bold; border-bottom: 3px solid transparent; transition: 0.2s; }
        .tab-btn.active { color: #e51e25; border-bottom-color: #e51e25; background: #252525; }
        .content-area { flex: 1; overflow-y: auto; padding: 20px; position: relative; }
        .tab-pane { display: none; max-width: 800px; margin: 0 auto; }
        .tab-pane.active { display: block; }

        /* CARDS */
        .card { background: #252525; padding: 12px; margin-bottom: 10px; border-radius: 6px; border: 1px solid #444; position: relative; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .card-spell { border-left: 4px solid #8af; }
        .card-feature { border-left: 4px solid #fa8; }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 5px; }
        .card-title { font-size: 1.1em; font-weight: bold; color: #fff; }
        .card-meta { font-size: 0.8em; color: #aaa; }
        .card-desc { font-size: 0.9em; color: #ccc; font-style: italic; margin-bottom: 10px; padding-left: 8px; border-left: 2px solid #444; }
        
        .roll-btn-row { display: flex; gap: 5px; }
        .roll-btn { flex: 1; border: none; padding: 8px; border-radius: 4px; cursor: pointer; font-weight: bold; color: white; font-size: 0.9em; transition: 0.2s; }
        .btn-hit { background: #2b5fa3; }
        .btn-dmg { background: #a33; }
        .btn-heal { background: #2a7a3a; }
        .btn-effect { background: #444; color:#d4af37; }

        /* SLOTS & SKILLS */
        .slot-container { background: #222; padding: 10px; border-radius: 6px; border: 1px solid #444; margin-bottom: 20px; }
        .slot-row { display: flex; justify-content: space-between; align-items: center; padding: 4px 0; border-bottom: 1px solid #333; }
        .slot-bubbles { display: flex; gap: 5px; }
        .bubble { width: 18px; height: 18px; border-radius: 50%; border: 1px solid #666; cursor: pointer; background: #333; }
        .bubble.used { background: #8af; border-color: #8af; box-shadow: 0 0 5px #8af; }
        
        .saves-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px; margin-bottom: 20px; }
        .save-box { background: #252525; padding: 8px; border-radius: 4px; text-align: center; border: 1px solid #444; cursor: pointer; }
        .save-val { font-size: 1.2em; font-weight: bold; color: #fff; }
        
        .skill-list { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .skill-btn { background: #252525; padding: 8px 12px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border: 1px solid #333; }
        .skill-mod { font-weight: bold; color: #fff; }

        /* CHAT */
        #chat { height: 150px; background: #111; border-top: 2px solid #e51e25; padding: 10px; overflow-y: scroll; font-family: monospace; font-size: 0.9em; flex-shrink: 0; }
        .msg { margin-bottom: 4px; padding: 4px 8px; border-left: 3px solid #555; }
        .msg strong { color: #8af; }
        .res-hit { color: #8af; font-weight: bold; } .res-dmg { color: #e51e25; font-weight: bold; } 
    </style>
</head>
<body>

<header>
    <div class="char-identity">
        <h1 id="charName">...</h1>
        <div id="classDisplay" class="sub">Loading...</div>
    </div>
    <div class="combat-stats">
        <div class="rest-group">
            <button class="btn-rest short" onclick="takeRest('short')">Short</button>
            <button class="btn-rest long" onclick="takeRest('long')">Long</button>
        </div>
        <div class="stat-badge hp-box">
            <div class="stat-val"><input type="number" id="hpInput" class="hp-input" onchange="updateHP()"></div>
            <div class="stat-label">/ <span id="hpMax"></span> HP</div>
        </div>
        <div class="stat-badge">
            <div class="stat-val" id="dispAC">10</div>
            <div class="stat-label">AC</div>
        </div>
        <div class="stat-badge init-box" onclick="rollInit()">
            <div class="stat-val" id="dispInit">+0</div>
            <div class="stat-label">Init</div>
        </div>
        <a href="index.html" class="btn-rest" style="text-decoration:none; background:#444;">Exit</a>
    </div>
</header>

<div class="tab-nav">
    <button class="tab-btn active" onclick="openTab('tab-actions')">‚öîÔ∏è Actions</button>
    <button class="tab-btn" onclick="openTab('tab-spells')">‚ú® Spells</button>
    <button class="tab-btn" onclick="openTab('tab-skills')">üé≤ Skills</button>
    <button class="tab-btn" onclick="openTab('tab-inv')">üéí Inventory</button>
</div>

<div class="content-area">
    <div id="tab-actions" class="tab-pane active">
        <h3 style="color:#e51e25; border-bottom:1px solid #444;">Attacks & Features</h3>
        <div id="attackList"></div>
    </div>
    <div id="tab-spells" class="tab-pane">
        <div id="slotTracker" class="slot-container"></div>
        <div id="spellList"></div>
    </div>
    <div id="tab-skills" class="tab-pane">
        <h3 style="color:#e51e25; border-bottom:1px solid #444;">Saving Throws</h3>
        <div class="saves-grid" id="savesList"></div>
        <h3 style="color:#e51e25; border-bottom:1px solid #444;">Skills</h3>
        <div class="skill-list" id="skillList"></div>
    </div>
    <div id="tab-inv" class="tab-pane">
        <div id="invList" style="padding:10px; color:#ccc;"></div>
    </div>
</div>

<div id="chat"></div>

<script>
    // --- SETUP ---
    const params = new URLSearchParams(window.location.search);
    const ROOM_ID = params.get('room');
    const CHAR_ID = params.get('id');
    if (!ROOM_ID || !CHAR_ID) window.location.href = "index.html";

    let CHAR = {};
    let STATS = {};
    let PROF = 2;
    let INIT_BONUS = 0;

    // --- FIREBASE LISTENERS ---
    db.ref(`campaigns/${ROOM_ID}/characters/${CHAR_ID}`).on('value', snap => {
        if(!snap.exists()) return;
        CHAR = snap.val();
        
        // Defaults if missing (for older chars)
        if(!CHAR.slots_used) CHAR.slots_used = {};
        if(!CHAR.charges) CHAR.charges = {};
        
        renderAll();
    });

    db.ref(`campaigns/${ROOM_ID}/chat`).limitToLast(20).on('child_added', snap => {
        const d = snap.val();
        const c = document.getElementById('chat');
        let html = `<div class="msg"><strong>${d.user}</strong>: ${d.lbl}`;
        if(d.sub_type === 'hit') html += ` -> <span class="${d.nat20?'res-crit':'res-hit'}">${d.val}</span> <small>${d.formula}</small>`; 
        else if(d.sub_type === 'dmg') html += ` -> <span class="res-dmg">${d.val}</span> <small>${d.formula}</small>`;
        else html += ` -> <b>${d.val || d.tot}</b>`;
        c.innerHTML = html + "</div>" + c.innerHTML;
    });

    // --- RENDERING ---
    function renderAll() {
        // 1. Stats & Meta
        document.getElementById('charName').innerText = CHAR.name;
        document.getElementById('classDisplay').innerText = `${CHAR.race} ${CHAR.class}`;
        document.getElementById('hpInput').value = CHAR.hp_curr;
        document.getElementById('hpMax').innerText = CHAR.hp_max;

        // Calc Mods & Prof
        // Simplified Level Calculation (Assuming Level 1 for this MVP, or store Level in DB)
        let level = 1; 
        PROF = 2 + Math.floor((level - 1)/4);
        
        ['STR','DEX','CON','INT','WIS','CHA'].forEach(s => {
            STATS[s] = Math.floor((CHAR.stats[s] - 10) / 2);
        });

        // Init & AC
        INIT_BONUS = STATS['DEX'];
        document.getElementById('dispInit').innerText = (INIT_BONUS>=0?"+":"") + INIT_BONUS;
        document.getElementById('dispAC').innerText = 10 + STATS['DEX']; // TODO: Add armor logic

        renderActions();
        renderSkills();
        renderSlots();
        renderInv();
    }

    function renderActions() {
        const atkDiv = document.getElementById('attackList');
        const spellDiv = document.getElementById('spellList');
        atkDiv.innerHTML = ""; spellDiv.innerHTML = "";

        if(!CHAR.inventory) return;

        CHAR.inventory.forEach(item => {
            // Match item name to rules database
            let data = ALL_ACTIONS.find(a => a.name === item);
            if(!data && ALL_SPELLS) data = ALL_SPELLS.find(a => a.name === item);
            if(!data) return; // Skip unknown items

            // Calculate Bonuses
            let useStat = data.stat || "STR";
            if(data.category === "Spell") useStat = "INT"; // Default Int for now
            let mod = STATS[useStat] || 0;
            let hitBonus = mod + PROF;
            let dmgStr = (data.dice && data.dice.includes('d')) ? `${data.dice} ${mod>=0?'+':''}${mod}` : data.dice;

            // HTML Construction
            const card = document.createElement('div');
            card.className = "card " + (data.category === "Spell" ? "card-spell" : "");
            
            let btns = "";
            if(data.category === "Spell" && data.type === "Healing") {
                btns = `<button class="roll-btn btn-heal" onclick="rollDmg('${item}', '${data.dice}', ${mod}, 'heal')">üíö Heal (${dmgStr})</button>`;
            } else if(data.dice && data.dice.includes('d')) {
                btns = `<div class="roll-btn-row">
                    <button class="roll-btn btn-hit" onclick="rollAtk('${item}', ${hitBonus})">‚öîÔ∏è Hit (${hitBonus>=0?'+':''}${hitBonus})</button>
                    <button class="roll-btn btn-dmg" onclick="rollDmg('${item}', '${data.dice}', ${mod}, 'dmg')">ü©∏ Dmg (${dmgStr})</button>
                </div>`;
            } else {
                btns = `<button class="roll-btn btn-effect" onclick="pushChat('${item}', 'Used Feature', '-')">Use Feature</button>`;
            }

            card.innerHTML = `
                <div class="card-header"><span class="card-title">${item}</span><span class="card-meta">${data.type}</span></div>
                <div class="card-desc">${data.desc || ''}</div>
                ${btns}
            `;

            if(data.category === "Spell") spellDiv.appendChild(card);
            else atkDiv.appendChild(card);
        });
    }

    function renderSlots() {
        // Hardcoded Logic for Level 1 Warlock/Wizard for MVP
        // In a real app, calculate this based on Class Table
        const div = document.getElementById('slotTracker');
        div.innerHTML = "";
        
        let maxSlots = [0, 0]; // [Lvl 1, Lvl 2...]
        if(CHAR.class === "Wizard") maxSlots = [2, 0];
        if(CHAR.class === "Cleric") maxSlots = [2, 0];
        if(CHAR.class === "Warlock") maxSlots = [1, 0]; // Pact magic

        maxSlots.forEach((max, idx) => {
            if(max === 0) return;
            let lvl = idx + 1;
            let used = (CHAR.slots_used && CHAR.slots_used[lvl]) || 0;
            
            let bubbles = "";
            for(let i=0; i<max; i++) {
                let cls = (i < used) ? "bubble used" : "bubble";
                bubbles += `<div class="${cls}" onclick="toggleSlot(${lvl}, ${i})"></div>`;
            }
            
            div.innerHTML += `<div class="slot-row"><span style="color:#8af; font-weight:bold;">Level ${lvl}</span><div class="slot-bubbles">${bubbles}</div></div>`;
        });
    }

    function renderSkills() {
        const div = document.getElementById('skillList'); div.innerHTML = "";
        const saveDiv = document.getElementById('savesList'); saveDiv.innerHTML = "";

        // Saves
        ['STR','DEX','CON','INT','WIS','CHA'].forEach(s => {
            let mod = STATS[s];
            saveDiv.innerHTML += `<div class="save-box" onclick="rollCheck('${s} Save', ${mod})"><div style="font-size:0.7em; color:#888;">${s}</div><div class="save-val">${mod>=0?'+':''}${mod}</div></div>`;
        });

        // Skills
        for (const [skill, stat] of Object.entries(SKILLS_LIST)) {
            let mod = STATS[stat];
            div.innerHTML += `<div class="skill-btn" onclick="rollCheck('${skill}', ${mod})"><span>${skill} <small style="color:#666">(${stat})</small></span><span class="skill-mod">${mod>=0?'+':''}${mod}</span></div>`;
        }
    }

    function renderInv() {
        const div = document.getElementById('invList');
        div.innerHTML = (CHAR.inventory || []).map(i => `<div>‚Ä¢ ${i}</div>`).join('');
    }

    // --- LOGIC ---
    function updateHP() {
        const val = parseInt(document.getElementById('hpInput').value);
        db.ref(`campaigns/${ROOM_ID}/characters/${CHAR_ID}/hp_curr`).set(val);
    }

    function toggleSlot(lvl, idx) {
        let current = (CHAR.slots_used && CHAR.slots_used[lvl]) || 0;
        let newVal = (idx + 1 === current) ? idx : idx + 1; // Toggle logic
        db.ref(`campaigns/${ROOM_ID}/characters/${CHAR_ID}/slots_used/${lvl}`).set(newVal);
    }

    function takeRest(type) {
        if(!confirm(`Take a ${type} rest?`)) return;
        let updates = {};
        if(type === 'long') {
            updates['hp_curr'] = CHAR.hp_max;
            updates['slots_used'] = {}; // Reset slots
        }
        db.ref(`campaigns/${ROOM_ID}/characters/${CHAR_ID}`).update(updates);
    }

    function rollInit() { rollCheck("Initiative", INIT_BONUS); }

    function rollAtk(name, mod) {
        const d20 = Math.floor(Math.random()*20)+1;
        pushChat(`Atk ${name}`, d20+mod, `${d20} + ${mod}`, 'hit', d20===20);
    }

    function rollDmg(name, dice, mod, type) {
        if(!dice.includes('d')) return;
        let parts = dice.split('d');
        let n = parseInt(parts[0]);
        let sides = parseInt(parts[1]);
        let total = 0;
        for(let i=0; i<n; i++) total += Math.floor(Math.random()*sides)+1;
        pushChat(`${name}`, total+mod, `[${dice}] + ${mod}`, type);
    }

    function rollCheck(lbl, mod) {
        const d20 = Math.floor(Math.random()*20)+1;
        pushChat(lbl, d20+mod, `${d20} + ${mod}`);
    }

    function pushChat(lbl, val, formula, subType='gen', nat20=false) {
        db.ref(`campaigns/${ROOM_ID}/chat`).push({
            user: CHAR.name,
            lbl: lbl,
            val: val,
            formula: formula,
            sub_type: subType,
            nat20: nat20,
            timestamp: Date.now()
        });
    }

    function openTab(id) {
        document.querySelectorAll('.tab-pane').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        event.target.classList.add('active');
    }
</script>
</body>
</html>