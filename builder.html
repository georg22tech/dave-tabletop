<!DOCTYPE html>
<html>
<head>
    <title>Advanced Character Builder</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script type="module" src="game_rules.js"></script>
    <script src="config.js"></script> 
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #121212; color: #eee; margin: 0; padding: 20px; display: flex; justify-content: center; min-height: 100vh; }
        .builder-container { max-width: 800px; width: 100%; background: #1e1e1e; padding: 30px; border-radius: 8px; border: 1px solid #333; display: flex; flex-direction: column; }
        h1 { color: #e51e25; border-bottom: 1px solid #333; padding-bottom: 10px; margin-top: 0; text-align: center; }
        
        /* STEPS & UI */
        .step { display: none; animation: fadeIn 0.3s; }
        .step.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        label { display: block; color: #8af; font-weight: bold; margin-bottom: 5px; margin-top: 15px; font-size: 0.9em; }
        input, select, textarea { width: 100%; padding: 10px; background: #2a2a2a; border: 1px solid #444; color: white; border-radius: 4px; box-sizing: border-box; }
        input:focus, select:focus { border-color: #e51e25; outline: none; }
        
        /* RP GRID */
        .rp-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px; }

        /* CLASS ROW */
        .class-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; background: #252525; padding: 10px; border-radius: 4px;}
        .class-row select { flex: 2; }
        .class-row input { flex: 1; text-align: center; }
        .btn-small { padding: 5px 10px; background: #444; color: #fff; border: none; cursor: pointer; border-radius: 4px;}
        .btn-small:hover { background: #666; }
        .btn-remove { background: #a33; } .btn-remove:hover { background: #c44; }

        /* STATS */
        .stat-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; }
        .stat-box { text-align: center; background: #252525; padding: 10px; border-radius: 4px; border: 1px solid #333; }
        .stat-box select { padding: 5px; text-align: center; }
        .bonus-badge { color: #4f4; font-size: 0.8em; display: block; margin-top: 5px; }

        /* INVENTORY SEARCH */
        .search-results { max-height: 200px; overflow-y: auto; background: #252525; border: 1px solid #444; display:none; position: absolute; width: 90%; z-index: 100; }
        .search-item { padding: 8px; border-bottom: 1px solid #333; cursor: pointer; display: flex; justify-content: space-between; }
        .search-item:hover { background: #333; }
        .inv-list { margin-top: 10px; }
        .inv-item { background: #222; padding: 8px; margin-bottom: 5px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; border-left: 3px solid #555; }
        
        /* NAV */
        .nav-btns { margin-top: 30px; padding-top: 20px; display: flex; justify-content: space-between; border-top: 1px solid #333; }
        .btn { padding: 12px 25px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 1em; }
        .btn-next { background: #e51e25; color: white; }
        .btn-prev { background: #444; color: white; }
        
        .pill { background: #2a7a3a; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8em; margin-right: 5px; display: inline-block; }
    </style>
</head>
<body>

<div class="builder-container">
    <h1 id="headerTitle">Character Builder</h1>
    
    <div id="step1" class="step active">
        <label>Character Name</label>
        <input type="text" id="charName" placeholder="Name">

        <label>Race</label>
        <select id="charRace" onchange="updateRaceInfo()"></select>
        <div id="raceSummary" style="color:#aaa; font-size:0.9em; margin-top:5px;"></div>

        <label>Background (Required)</label>
        <select id="charBackground" onchange="updateBackgroundInfo()">
            <option value="">Select Background...</option>
        </select>
        <div id="bgSummary" style="color:#aaa; font-size:0.9em; margin-top:5px;"></div>

        <label>Classes & Levels</label>
        <div id="classContainer"></div>
        <button class="btn-small" onclick="addClassRow()" style="margin-top:5px;">+ Add Multiclass</button>
        <div id="classSummary" style="color:#aaa; font-size:0.9em; margin-top:10px;"></div>
    </div>

    <div id="step2" class="step">
        <div style="text-align:center; color:#888; margin-bottom:15px; font-size:0.9em;">
            Standard Array: 15, 14, 13, 12, 10, 8
        </div>
        <div class="stat-grid">
            </div>
        <div style="margin-top:20px; text-align:center; background:#222; padding:10px;">
            <strong>Total Level:</strong> <span id="totalLevelDisplay">1</span> | 
            <strong>Max HP:</strong> <span id="calcHP" style="color:#4f4;">0</span>
        </div>
    </div>

    <div id="step3" class="step">
        <label>Auto-Granted Skills (Race & Background)</label>
        <div id="fixedSkillsArea" style="margin-bottom:15px; padding:10px; background:#222; border-radius:4px;"></div>
        
        <label>Class Skills</label>
        <div id="classSkillArea"></div>
    </div>

    <div id="step4" class="step">
        <label>Starting Equipment</label>
        <div style="font-size:0.85em; color:#aaa; margin-bottom:10px;">
            Items from your Class and Background have been pre-selected. Use the search to add more.
        </div>

        <div style="position:relative;">
            <input type="text" id="itemSearch" placeholder="Search Items (Swords, Armor, Potions...)" onkeyup="filterItems()">
            <div id="searchResults" class="search-results"></div>
        </div>

        <div id="inventoryList" class="inv-list"></div>
        
        <label>Gold Pieces (GP)</label>
        <input type="number" id="charGold" value="15">

        <hr style="border: 0; border-top: 1px solid #333; margin: 20px 0;">

        <label>Appearance & Identity</label>
        <div class="rp-grid">
            <input type="text" id="rpAge" placeholder="Age">
            <input type="text" id="rpHeight" placeholder="Height">
            <input type="text" id="rpWeight" placeholder="Weight">
        </div>
        <div class="rp-grid">
            <input type="text" id="rpEyes" placeholder="Eyes (e.g. Blue)">
            <input type="text" id="rpHair" placeholder="Hair (e.g. Blonde)">
            <input type="text" id="rpSkin" placeholder="Skin (e.g. Tan)">
        </div>

        <label>Alignment</label>
        <select id="charAlign">
            <option value="True Neutral">Select Alignment...</option>
            <option value="Lawful Good">Lawful Good</option>
            <option value="Neutral Good">Neutral Good</option>
            <option value="Chaotic Good">Chaotic Good</option>
            <option value="Lawful Neutral">Lawful Neutral</option>
            <option value="True Neutral">True Neutral</option>
            <option value="Chaotic Neutral">Chaotic Neutral</option>
            <option value="Lawful Evil">Lawful Evil</option>
            <option value="Neutral Evil">Neutral Evil</option>
            <option value="Chaotic Evil">Chaotic Evil</option>
        </select>

        <label>Backstory / Notes</label>
        <textarea id="charBack" rows="3" placeholder="Character history, personality traits, etc..."></textarea>
    </div>

    <div class="nav-btns">
        <button class="btn btn-prev" onclick="changeStep(-1)" id="btnPrev" style="visibility:hidden;">Back</button>
        <button class="btn btn-next" onclick="changeStep(1)" id="btnNext">Next</button>
    </div>
</div>

<script type="module">
    import { RACES, CLASSES, SKILLS_LIST, ALL_ACTIONS, ALL_ITEMS, ALL_WEAPONS, ALL_ARMOR } from './game_rules.js';

    // BACKGROUND DATA
    const BACKGROUNDS = {
        "Acolyte": { skills: ["Insight", "Religion"], items: ["Holy Symbol", "Prayer Book", "Stick of Incense", "Vestments", "Rations"] },
        "Criminal": { skills: ["Deception", "Stealth"], items: ["Crowbar", "Dark Clothes", "Rations"] },
        "Folk Hero": { skills: ["Animal Handling", "Survival"], items: ["Shovel", "Pot", "Civilian Clothes", "Rations"] },
        "Noble": { skills: ["History", "Persuasion"], items: ["Fine Clothes", "Signet Ring", "Scroll of Pedigree"] },
        "Sage": { skills: ["Arcana", "History"], items: ["Ink Pen", "Small Knife", "Letter from Colleague", "Common Clothes"] },
        "Soldier": { skills: ["Athletics", "Intimidation"], items: ["Rank Insignia", "Trophy", "Bone Dice", "Common Clothes", "Rations"] },
        "Charlatan": { skills: ["Deception", "Sleight of Hand"], items: ["Disguise Kit", "Fine Clothes", "Tools of the Con"] },
        "Entertainer": { skills: ["Acrobatics", "Performance"], items: ["Musical Instrument", "Costume", "Rations"] },
        "Outlander": { skills: ["Athletics", "Survival"], items: ["Staff", "Hunting Trap", "Traveler's Clothes", "Rations"] },
        "Urchin": { skills: ["Sleight of Hand", "Stealth"], items: ["Small Knife", "Map of the City", "Pet Mouse", "Token", "Common Clothes"] }
    };

    // VARIABLES
    const STAT_KEYS = ['STR','DEX','CON','INT','WIS','CHA'];
    const STANDARD_ARRAY = [15, 14, 13, 12, 10, 8];
    let selectedInventory = []; 
    let currentStep = 1;
    let totalLevels = 1;

    // INIT
    const params = new URLSearchParams(window.location.search);
    const ROOM_ID = params.get('room');
    const EDIT_ID = params.get('id');
    
    if (!window.db) {
        if(typeof firebase !== 'undefined') window.db = firebase.database();
    }

    // Populate Selects
    const raceSel = document.getElementById('charRace');
    const bgSel = document.getElementById('charBackground');
    
    raceSel.innerHTML = "";
    Object.keys(RACES).sort().forEach(r => raceSel.add(new Option(r,r)));

    bgSel.innerHTML = '<option value="">Select Background...</option>';
    Object.keys(BACKGROUNDS).sort().forEach(b => bgSel.add(new Option(b,b)));

    const statGrid = document.querySelector('.stat-grid');
    statGrid.innerHTML = ""; 
    STAT_KEYS.forEach(stat => {
        statGrid.innerHTML += `
            <div class="stat-box">
                <label>${stat}</label>
                <select id="base_${stat}" onchange="recalcStats()">
                    <option value="">-</option>
                    ${STANDARD_ARRAY.map(n => `<option value="${n}">${n}</option>`).join('')}
                </select>
                <span id="bon_${stat}" class="bonus-badge"></span>
            </div>
        `;
    });

    // ATTACH FUNCTIONS TO GLOBAL SCOPE
    
    window.updateRaceInfo = function() {
        const r = RACES[raceSel.value];
        if (!r) return;
        let txt = "Bonuses: "; 
        for(let s in r.bonuses) txt+=`${s} +${r.bonuses[s]} `;
        document.getElementById('raceSummary').innerText = txt;
        window.recalcStats();
    };

    window.updateBackgroundInfo = function() {
        const bg = BACKGROUNDS[bgSel.value];
        if(!bg) {
            document.getElementById('bgSummary').innerText = "";
            return;
        }
        document.getElementById('bgSummary').innerText = `Skills: ${bg.skills.join(', ')}`;
        window.renderSkills();
        window.autoPopulateGear(); 
    };

    window.addClassRow = function() {
        const container = document.getElementById('classContainer');
        const div = document.createElement('div');
        div.className = 'class-row';
        div.innerHTML = `
            <select class="cls-select" onchange="recalcClassDetails()">
                ${Object.keys(CLASSES).sort().map(c => `<option value="${c}">${c}</option>`).join('')}
            </select>
            <input type="number" class="cls-level" value="1" min="1" max="20" onchange="recalcClassDetails()">
            <button class="btn-small btn-remove" onclick="this.parentElement.remove(); recalcClassDetails()">X</button>
        `;
        container.appendChild(div);
        window.recalcClassDetails();
    };

    window.recalcClassDetails = function() {
        let totalLvl = 0;
        let hpBase = 0;
        let summary = [];
        
        const rows = document.querySelectorAll('.class-row');
        if (rows.length === 0) return;

        rows.forEach((row, index) => {
            const clsName = row.querySelector('.cls-select').value;
            const lvl = parseInt(row.querySelector('.cls-level').value) || 1;
            const cData = CLASSES[clsName];
            
            totalLvl += lvl;
            
            if(index === 0) {
                hpBase += cData.hit_die;
                hpBase += (Math.ceil(cData.hit_die / 2) + 1) * (lvl - 1);
            } else {
                hpBase += (Math.ceil(cData.hit_die / 2) + 1) * lvl;
            }
            summary.push(`${clsName} ${lvl}`);
        });

        totalLevels = totalLvl;
        document.getElementById('totalLevelDisplay').innerText = totalLevels;
        document.getElementById('classSummary').innerText = summary.join(" / ");
        
        document.getElementById('calcHP').dataset.base = hpBase;
        window.recalcStats();
        window.renderSkills();
        window.autoPopulateGear();
    };

    window.recalcStats = function() {
        const rData = RACES[raceSel.value];
        if (!rData) return;
        
        let conMod = 0;

        STAT_KEYS.forEach(s => {
            let baseElement = document.getElementById(`base_${s}`);
            let base = parseInt(baseElement.value) || 0;
            let bonus = (rData.bonuses && rData.bonuses[s]) ? rData.bonuses[s] : 0;
            document.getElementById(`bon_${s}`).innerText = bonus > 0 ? `+${bonus}` : "";
            
            if(s === 'CON') conMod = Math.floor(((base + bonus) - 10) / 2);
        });

        let hpBase = parseInt(document.getElementById('calcHP').dataset.base) || 0;
        let totalHP = hpBase + (conMod * totalLevels) + (rData.hp_bonus || 0) * totalLevels; 
        document.getElementById('calcHP').innerText = totalHP > 0 ? totalHP : 0;
    };

    window.renderSkills = function() {
        const race = RACES[raceSel.value];
        const bg = BACKGROUNDS[bgSel.value] || {skills:[]};
        
        const fixed = new Set([...(race.skills || []), ...bg.skills]);
        const fixedArea = document.getElementById('fixedSkillsArea');
        fixedArea.innerHTML = "";
        fixed.forEach(s => fixedArea.innerHTML += `<span class="pill">${s}</span>`);

        const rows = document.querySelectorAll('.class-row');
        const classArea = document.getElementById('classSkillArea');
        classArea.innerHTML = "";

        if(rows.length > 0) {
            const clsName = rows[0].querySelector('.cls-select').value;
            const cData = CLASSES[clsName];
            const num = (cData.num_skills || 2);
            
            classArea.innerHTML = `<p style="font-size:0.9em; color:#aaa;">Select ${num} skills from ${clsName}:</p>`;
            
            const options = cData.skill_options || Object.keys(SKILLS_LIST);
            
            for(let i=0; i<num; i++) {
                let sel = document.createElement('select');
                sel.className = 'skill-choice';
                sel.style.marginBottom = "5px";
                sel.add(new Option("- Select Skill -", ""));
                options.forEach(opt => {
                    if(!fixed.has(opt)) sel.add(new Option(opt, opt));
                });
                classArea.appendChild(sel);
            }
        }
    };

    window.autoPopulateGear = function() {
        selectedInventory = []; 
        const invList = document.getElementById('inventoryList');
        invList.innerHTML = "";

        const bg = BACKGROUNDS[bgSel.value];
        if(bg && bg.items) {
            bg.items.forEach(itemName => addItemByName(itemName, "Background"));
        }

        const rows = document.querySelectorAll('.class-row');
        if(rows.length > 0) {
            const clsName = rows[0].querySelector('.cls-select').value;
            const cData = CLASSES[clsName];
            const gear = cData.items || cData.starting_gear || [];
            gear.forEach(itemName => addItemByName(itemName, "Class"));
        }
        
        window.renderInventory();
    };

    function addItemByName(name, source) {
        const found = ALL_ACTIONS.find(i => i.name.toLowerCase() === name.toLowerCase());
        if(found) {
            selectedInventory.push({ ...found, source: source, equip: false });
        } else {
            selectedInventory.push({ name: name, category: "Item", source: source, equip: false });
        }
    }

    window.filterItems = function() {
        const q = document.getElementById('itemSearch').value.toLowerCase();
        const resDiv = document.getElementById('searchResults');
        resDiv.innerHTML = "";
        
        if(q.length < 2) { resDiv.style.display = 'none'; return; }
        
        const hits = ALL_ACTIONS.filter(i => 
            (i.category === "Adventuring Gear" || i.category === "Armor" || i.category === "Simple Melee" || i.category === "Martial Melee" || i.category === "Simple Ranged" || i.category === "Martial Ranged" || i.category === "Potion" || i.category === "Tool" || i.category === "Magic Weapon" || i.category === "Magic Armor") 
            && i.name.toLowerCase().includes(q)
        ).slice(0, 10);

        if(hits.length > 0) {
            resDiv.style.display = 'block';
            hits.forEach(item => {
                const div = document.createElement('div');
                div.className = 'search-item';
                div.innerHTML = `<span>${item.name}</span> <span style="font-size:0.8em; color:#888;">${item.category}</span>`;
                div.onclick = () => {
                    selectedInventory.push({ ...item, source: "Custom", equip: false });
                    window.renderInventory();
                    document.getElementById('itemSearch').value = "";
                    resDiv.style.display = 'none';
                };
                resDiv.appendChild(div);
            });
        }
    };

    window.renderInventory = function() {
        const list = document.getElementById('inventoryList');
        list.innerHTML = "";
        selectedInventory.forEach((item, idx) => {
            const div = document.createElement('div');
            div.className = 'inv-item';
            div.innerHTML = `
                <div>
                    <strong style="color: ${item.source === 'Custom' ? '#fff' : '#8af'};">${item.name}</strong>
                    <div style="font-size:0.8em; color:#aaa;">${item.category || "Item"}</div>
                </div>
                <button class="btn-small btn-remove" onclick="removeItem(${idx})">x</button>
            `;
            list.appendChild(div);
        });
    };

    window.removeItem = function(idx) {
        selectedInventory.splice(idx, 1);
        window.renderInventory();
    };

    window.changeStep = function(dir) {
        if(currentStep === 1 && dir === 1) {
            if(!document.getElementById('charName').value) return alert("Name required.");
            if(!bgSel.value) return alert("Background required.");
        }
        
        document.getElementById(`step${currentStep}`).classList.remove('active');
        currentStep += dir;
        
        if(currentStep > 4) { window.saveCharacter(); return; }
        
        document.getElementById(`step${currentStep}`).classList.add('active');
        document.getElementById('btnPrev').style.visibility = currentStep === 1 ? 'hidden' : 'visible';
        document.getElementById('btnNext').innerText = currentStep === 4 ? "Finish" : "Next";
        
        const titles = ["", "Identity", "Stats", "Skills", "Finalize"];
        document.getElementById('headerTitle').innerText = titles[currentStep];
    };

    window.saveCharacter = function() {
        const btn = document.getElementById('btnNext');
        btn.innerText = "Saving..."; btn.disabled = true;

        let classesArr = [];
        document.querySelectorAll('.class-row').forEach(row => {
            classesArr.push({
                name: row.querySelector('.cls-select').value,
                level: parseInt(row.querySelector('.cls-level').value)
            });
        });

        const rData = RACES[raceSel.value];
        let baseStats = {};
        let finalStats = {};
        STAT_KEYS.forEach(s => {
            let b = parseInt(document.getElementById(`base_${s}`).value);
            let bon = (rData.bonuses && rData.bonuses[s]) ? rData.bonuses[s] : 0;
            baseStats[s] = b;
            finalStats[s] = b + bon;
        });

        let skills = new Set();
        document.querySelectorAll('#fixedSkillsArea .pill').forEach(el => skills.add(el.innerText));
        document.querySelectorAll('.skill-choice').forEach(sel => { if(sel.value) skills.add(sel.value); });

        let finalItems = [...selectedInventory];
        let knownSpells = [...(rData.auto_spells || [])];
        classesArr.forEach(c => {
            if(CLASSES[c.name].auto_spells) knownSpells.push(...CLASSES[c.name].auto_spells);
        });

        const charData = {
            name: document.getElementById('charName').value,
            race: raceSel.value,
            background: bgSel.value,
            classes: classesArr,
            base_stats: baseStats,
            stats: finalStats,
            hp_max: parseInt(document.getElementById('calcHP').innerText),
            hp_curr: parseInt(document.getElementById('calcHP').innerText),
            alignment: document.getElementById('charAlign').value,
            backstory: document.getElementById('charBack').value,
            inventory: finalItems,
            coins: { gp: parseInt(document.getElementById('charGold').value) || 0 },
            skills: Array.from(skills),
            spells_known: knownSpells,
            // RP FIELDS
            age: document.getElementById('rpAge').value,
            height: document.getElementById('rpHeight').value,
            weight: document.getElementById('rpWeight').value,
            eyes: document.getElementById('rpEyes').value,
            hair: document.getElementById('rpHair').value,
            skin: document.getElementById('rpSkin').value
        };

        const ref = EDIT_ID ? window.db.ref(`campaigns/${ROOM_ID}/characters/${EDIT_ID}`) : window.db.ref(`campaigns/${ROOM_ID}/characters`).push();
        
        (EDIT_ID ? ref.update(charData) : ref.set(charData)).then(() => {
            if(!EDIT_ID) {
                window.db.ref(`campaigns/${ROOM_ID}/encounters`).push({
                    name: charData.name, hp: charData.hp_max, max_hp: charData.hp_max, init: 0, type: 'player'
                });
            }
            window.location.href = `sheet.html?room=${ROOM_ID}&id=${ref.key || EDIT_ID}`;
        });
    };

    // STARTUP CALLS
    setTimeout(() => {
        window.addClassRow(); 
        window.updateRaceInfo();
    }, 100);

</script>
</body>
</html>
