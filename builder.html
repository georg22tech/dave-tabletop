<!DOCTYPE html>
<html>
<head>
    <title>Character Builder</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #121212; color: #eee; margin: 0; padding: 20px; display: flex; justify-content: center; min-height: 100vh; }
        .builder-container { max-width: 650px; width: 100%; background: #1e1e1e; padding: 30px; border-radius: 8px; border: 1px solid #333; display: flex; flex-direction: column; }
        
        h1 { color: #e51e25; border-bottom: 1px solid #333; padding-bottom: 10px; margin-top: 0; text-align: center; }
        
        .step { display: none; animation: fadeIn 0.3s; }
        .step.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        label { display: block; color: #8af; font-weight: bold; margin-bottom: 5px; margin-top: 15px; font-size: 0.9em; }
        input, select, textarea { width: 100%; padding: 12px; background: #2a2a2a; border: 1px solid #444; color: white; border-radius: 4px; box-sizing: border-box; font-size: 1em; }
        input:focus, select:focus { border-color: #e51e25; outline: none; }
        
        /* STAT GRID */
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }
        .stat-box { text-align: center; background: #252525; padding: 10px; border-radius: 4px; border: 1px solid #333; }
        .stat-box label { margin: 0 0 5px 0; color: #aaa; }
        .stat-box select { text-align: center; font-weight: bold; font-size: 1.1em; background: #1a1a1a; padding: 5px; cursor:pointer; color: #fff; }
        .bonus-badge { font-size: 0.8em; color: #4f4; display: block; height: 1.2em; margin-top: 5px; }
        
        /* RP GRID */
        .rp-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }

        /* SKILLS */
        .auto-skill { background: #2a7a3a; color: white; padding: 5px 10px; border-radius: 4px; margin-bottom: 5px; display: inline-block; font-size: 0.9em; }
        .skill-select-group { margin-bottom: 10px; }

        /* EQUIPMENT TOGGLE */
        .equip-toggle { display: flex; gap: 10px; margin-bottom: 15px; }
        .equip-opt { flex: 1; padding: 10px; border: 1px solid #444; text-align: center; cursor: pointer; background: #222; border-radius: 4px; }
        .equip-opt.selected { background: #e51e25; color: white; border-color: #e51e25; }

        /* FOOTER NAV */
        .nav-btns { margin-top: auto; padding-top: 20px; display: flex; justify-content: space-between; border-top: 1px solid #333; }
        .btn { padding: 12px 25px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 1em; transition: 0.2s; }
        .btn-next { background: #e51e25; color: white; } .btn-next:hover { background: #ff3b3b; }
        .btn-prev { background: #444; color: white; } .btn-prev:hover { background: #555; }
        
        .summary-box { background: #252525; padding: 10px; border-radius: 4px; font-size: 0.9em; color: #ccc; margin-top: 5px; }
    </style>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="config.js"></script>
    <script src="game_rules.js"></script>
</head>
<body>

<div class="builder-container">
    <h1 id="headerTitle">Basic Info</h1>
    
    <div id="step1" class="step active">
        <label>Character Name</label>
        <input type="text" id="charName" placeholder="e.g. Valeros">
        
        <label>Race</label>
        <select id="charRace" onchange="updateRaceInfo()"></select>
        <div id="raceSummary" class="summary-box"></div>

        <label>Class</label>
        <select id="charClass" onchange="updateClassInfo()"></select>
        <div id="classSummary" class="summary-box"></div>
    </div>

    <div id="step2" class="step">
        <div style="text-align:center; color:#888; margin-bottom:15px; font-size:0.9em;">
            Assign Standard Array: 15, 14, 13, 12, 10, 8.<br>
            <span style="color:#e51e25">You must select a value for every stat.</span>
        </div>
        
        <div class="stat-grid">
            <div class="stat-box"><label>STR</label><select id="base_STR" class="stat-sel" onchange="updateStatOptions()"></select><span id="bon_STR" class="bonus-badge"></span></div>
            <div class="stat-box"><label>DEX</label><select id="base_DEX" class="stat-sel" onchange="updateStatOptions()"></select><span id="bon_DEX" class="bonus-badge"></span></div>
            <div class="stat-box"><label>CON</label><select id="base_CON" class="stat-sel" onchange="updateStatOptions()"></select><span id="bon_CON" class="bonus-badge"></span></div>
            <div class="stat-box"><label>INT</label><select id="base_INT" class="stat-sel" onchange="updateStatOptions()"></select><span id="bon_INT" class="bonus-badge"></span></div>
            <div class="stat-box"><label>WIS</label><select id="base_WIS" class="stat-sel" onchange="updateStatOptions()"></select><span id="bon_WIS" class="bonus-badge"></span></div>
            <div class="stat-box"><label>CHA</label><select id="base_CHA" class="stat-sel" onchange="updateStatOptions()"></select><span id="bon_CHA" class="bonus-badge"></span></div>
        </div>
        
        <div class="summary-box" style="margin-top:20px; text-align:center;">
            <strong>Starting HP:</strong> <span id="calcHP" style="color:#4f4; font-weight:bold;"></span>
        </div>
    </div>

    <div id="step3" class="step">
        <label>Racial Skills (Auto-Added)</label>
        <div id="racialSkillsArea"></div>
        
        <label>Class Skills (Choose <span id="skillCount">2</span>)</label>
        <div id="skillSelectArea"></div>
    </div>

    <div id="step4" class="step">
        <label>Alignment</label>
        <select id="charAlign">
            <option value="Lawful Good">Lawful Good</option>
            <option value="Neutral Good">Neutral Good</option>
            <option value="Chaotic Good">Chaotic Good</option>
            <option value="Lawful Neutral">Lawful Neutral</option>
            <option value="True Neutral" selected>True Neutral</option>
            <option value="Chaotic Neutral">Chaotic Neutral</option>
            <option value="Lawful Evil">Lawful Evil</option>
            <option value="Neutral Evil">Neutral Evil</option>
            <option value="Chaotic Evil">Chaotic Evil</option>
        </select>

        <label>Starting Equipment</label>
        <div class="equip-toggle">
            <div class="equip-opt selected" id="optLoadout" onclick="setEquipMode('loadout')">Class Loadout</div>
            <div class="equip-opt" id="optGold" onclick="setEquipMode('gold')">Starting Gold</div>
        </div>

        <div id="loadoutSection">
            <div class="summary-box" id="classGearList"></div>
            <label>Add Tool / Kit</label>
            <select id="toolSelect"></select>
        </div>

        <div id="goldSection" style="display:none;">
            <label>Starting Gold Pieces (GP)</label>
            <input type="number" id="startGold" value="100">
            <div style="font-size:0.8em; color:#888; margin-top:5px;">Your inventory will start empty.</div>
        </div>

        <label>Appearance & Roleplay</label>
        <div class="rp-grid">
            <input type="text" id="rpAge" placeholder="Age">
            <input type="text" id="rpHeight" placeholder="Height">
            <input type="text" id="rpWeight" placeholder="Weight">
        </div>
        <div class="rp-grid" style="margin-top:10px;">
            <input type="text" id="rpEyes" placeholder="Eyes">
            <input type="text" id="rpHair" placeholder="Hair">
            <input type="text" id="rpSkin" placeholder="Skin">
        </div>
        <textarea id="charBack" rows="3" placeholder="Backstory / Notes" style="margin-top:10px;"></textarea>
    </div>

    <div class="nav-btns">
        <button class="btn btn-prev" onclick="changeStep(-1)" id="btnPrev" style="visibility:hidden;">Back</button>
        <button class="btn btn-next" onclick="changeStep(1)" id="btnNext">Next</button>
    </div>
</div>

<script>
    // --- SETUP ---
    const params = new URLSearchParams(window.location.search);
    const ROOM_ID = params.get('room');
    if(!ROOM_ID) window.location.href = "index.html";

    let currentStep = 1;
    const totalSteps = 4;
    const STAT_KEYS = ['STR','DEX','CON','INT','WIS','CHA'];
    const STANDARD_ARRAY = [15, 14, 13, 12, 10, 8];
    const TOOLS_LIST = ["None", "Thieves' Tools", "Smith's Tools", "Brewer's Supplies", "Mason's Tools", "Herbalism Kit", "Navigator's Tools", "Disguise Kit", "Poisoner's Kit", "Musical Instrument"];
    let equipMode = 'loadout';

    // --- POPULATION ---
    const raceSel = document.getElementById('charRace');
    Object.keys(RACES).sort().forEach(r => {
        let opt = document.createElement('option'); opt.value = r; opt.innerText = r; raceSel.appendChild(opt);
    });

    const classSel = document.getElementById('charClass');
    Object.keys(CLASSES).sort().forEach(c => {
        let opt = document.createElement('option'); opt.value = c; opt.innerText = c; classSel.appendChild(opt);
    });

    const toolSel = document.getElementById('toolSelect');
    TOOLS_LIST.forEach(t => {
        let opt = document.createElement('option'); opt.value = t; opt.innerText = t; toolSel.appendChild(opt);
    });

    // Initialize Stats (Start Empty)
    STAT_KEYS.forEach(s => {
        let sel = document.getElementById(`base_${s}`);
        let opt = document.createElement('option'); opt.value = ""; opt.innerText = "--"; opt.selected = true;
        sel.appendChild(opt);
        STANDARD_ARRAY.forEach(num => {
            let nOpt = document.createElement('option'); nOpt.value = num; nOpt.innerText = num;
            sel.appendChild(nOpt);
        });
    });

    // --- LOGIC ---
    function updateStatOptions() {
        // 1. Rebuild options for all dropdowns based on what is selected elsewhere
        STAT_KEYS.forEach(s => {
            let sel = document.getElementById(`base_${s}`);
            let currentVal = parseInt(sel.value);
            
            // Clear current options
            sel.innerHTML = "";
            
            // Always add Default (Empty)
            let def = document.createElement('option'); def.value = ""; def.innerText = "--"; 
            if(isNaN(currentVal)) def.selected = true;
            sel.appendChild(def);

            STANDARD_ARRAY.forEach(num => {
                // Is this number taken by another box?
                let taken = false;
                STAT_KEYS.forEach(otherS => {
                    if(s !== otherS) {
                        if(parseInt(document.getElementById(`base_${otherS}`).value) === num) taken = true;
                    }
                });

                if (!taken) {
                    let opt = document.createElement('option');
                    opt.value = num; opt.innerText = num;
                    if(num === currentVal) opt.selected = true;
                    sel.appendChild(opt);
                }
            });
        });
        calcStats();
    }

    function updateRaceInfo() {
        const r = RACES[raceSel.value];
        let txt = "Bonuses: ";
        for(let s in r.bonuses) txt += `${s} +${r.bonuses[s]} `;
        document.getElementById('raceSummary').innerText = txt;
        calcStats();
    }

    function updateClassInfo() {
        const c = CLASSES[classSel.value];
        document.getElementById('classSummary').innerText = `Hit Die: d${c.hit_die} | Saves: ${c.saves.join(', ')}`;
        
        // Update Loadout Text
        let gear = [...(c.items || c.starting_gear || []), "Rations", "Waterskin"];
        document.getElementById('classGearList').innerText = gear.join(", ");
        
        calcStats();
        renderSkillSelectors();
    }

    function calcStats() {
        const rData = RACES[raceSel.value];
        const cData = CLASSES[classSel.value];
        let conTotal = 10;

        STAT_KEYS.forEach(s => {
            let val = document.getElementById(`base_${s}`).value;
            let base = (val === "") ? 0 : parseInt(val);
            let bonus = (rData.bonuses && rData.bonuses[s]) ? rData.bonuses[s] : 0;
            
            let badge = document.getElementById(`bon_${s}`);
            badge.innerText = bonus > 0 ? `+${bonus} Race` : "";
            
            if(s === 'CON') conTotal = (base === 0) ? 10 : base + bonus;
        });

        // HP Calc
        let conMod = Math.floor((conTotal - 10) / 2);
        let hp = cData.hit_die + conMod + (rData.hp_bonus || 0);
        document.getElementById('calcHP').innerText = hp;
    }

    function renderSkillSelectors() {
        const cData = CLASSES[classSel.value];
        const rData = RACES[raceSel.value];
        
        const rArea = document.getElementById('racialSkillsArea');
        rArea.innerHTML = "";
        const rSkills = rData.skills || [];
        if(rSkills.length === 0) rArea.innerHTML = "<span style='color:#555; font-style:italic;'>None</span>";
        else rSkills.forEach(s => { rArea.innerHTML += `<div class="auto-skill">${s}</div>`; });

        const cArea = document.getElementById('skillSelectArea');
        cArea.innerHTML = "";
        
        let count = cData.num_skills || 2;
        if(classSel.value === "Rogue") count = 4;
        if(classSel.value === "Bard" || classSel.value === "Ranger") count = 3;
        
        document.getElementById('skillCount').innerText = count;
        const options = cData.skill_options || Object.keys(SKILLS_LIST); 

        for(let i=0; i<count; i++) {
            let sel = document.createElement('select');
            sel.className = "skill-select";
            sel.style.marginBottom = "10px";
            options.forEach(sk => {
                if(!rSkills.includes(sk)) {
                    let opt = document.createElement('option'); opt.value = sk; opt.innerText = sk; sel.appendChild(opt);
                }
            });
            cArea.appendChild(sel);
        }
    }

    function setEquipMode(mode) {
        equipMode = mode;
        if(mode === 'loadout') {
            document.getElementById('optLoadout').className = 'equip-opt selected';
            document.getElementById('optGold').className = 'equip-opt';
            document.getElementById('loadoutSection').style.display = 'block';
            document.getElementById('goldSection').style.display = 'none';
        } else {
            document.getElementById('optLoadout').className = 'equip-opt';
            document.getElementById('optGold').className = 'equip-opt selected';
            document.getElementById('loadoutSection').style.display = 'none';
            document.getElementById('goldSection').style.display = 'block';
        }
    }

    // --- NAVIGATION & SAVE ---
    function changeStep(dir) {
        // Validation Step 1
        if(currentStep === 1 && dir === 1 && !document.getElementById('charName').value) return alert("Please enter a name.");
        
        // Validation Step 2 (Stats)
        if(currentStep === 2 && dir === 1) {
            let allFilled = true;
            STAT_KEYS.forEach(s => { if(document.getElementById(`base_${s}`).value === "") allFilled = false; });
            if(!allFilled) return alert("Please select a value for every Ability Score.");
        }

        document.getElementById(`step${currentStep}`).classList.remove('active');
        currentStep += dir;
        
        if(currentStep > totalSteps) { saveCharacter(); return; }
        
        document.getElementById(`step${currentStep}`).classList.add('active');
        document.getElementById('btnPrev').style.visibility = (currentStep === 1) ? 'hidden' : 'visible';
        document.getElementById('btnNext').innerText = (currentStep === totalSteps) ? 'Create Character' : 'Next';
        
        const titles = ["", "Identity", "Ability Scores", "Skills", "Finalize"];
        document.getElementById('headerTitle').innerText = titles[currentStep];
    }

    function saveCharacter() {
        document.getElementById('btnNext').disabled = true;
        document.getElementById('btnNext').innerText = "Saving...";

        const rData = RACES[raceSel.value];
        const cData = CLASSES[classSel.value];
        
        let stats = {};
        STAT_KEYS.forEach(s => {
            let base = parseInt(document.getElementById(`base_${s}`).value);
            let bonus = (rData.bonuses && rData.bonuses[s]) ? rData.bonuses[s] : 0;
            stats[s] = base + bonus;
        });

        let conMod = Math.floor((stats['CON'] - 10) / 2);
        let hp = cData.hit_die + conMod + (rData.hp_bonus || 0);

        let finalSkills = [...(rData.skills || [])];
        document.querySelectorAll('.skill-select').forEach(sel => {
            if(!finalSkills.includes(sel.value)) finalSkills.push(sel.value);
        });

        // Inventory Logic
        let items = [];
        let coins = {cp:0, sp:0, ep:0, gp:0, pp:0};
        
        if(equipMode === 'loadout') {
            items = [...(cData.items || cData.starting_gear || []), "Rations", "Waterskin"];
            let tool = document.getElementById('toolSelect').value;
            if(tool !== "None") items.push(tool);
            coins.gp = 10; // Standard starter cash
        } else {
            coins.gp = parseInt(document.getElementById('startGold').value) || 0;
        }

        let autoSpells = [...(rData.auto_spells || []), ...(cData.auto_spells || [])];
        autoSpells.forEach(s => items.push(s)); 

        const charRef = firebase.database().ref(`campaigns/${ROOM_ID}/characters`).push();
        charRef.set({
            name: document.getElementById('charName').value,
            race: raceSel.value,
            class: classSel.value,
            alignment: document.getElementById('charAlign').value,
            backstory: document.getElementById('charBack').value,
            // Roleplay Fields
            age: document.getElementById('rpAge').value,
            height: document.getElementById('rpHeight').value,
            weight: document.getElementById('rpWeight').value,
            eyes: document.getElementById('rpEyes').value,
            hair: document.getElementById('rpHair').value,
            skin: document.getElementById('rpSkin').value,
            
            stats: stats,
            hp_curr: hp,
            hp_max: hp,
            skills: finalSkills,
            inventory: items,
            coins: coins,
            slots_used: {},
            charges: {}
        }).then(() => {
            firebase.database().ref(`campaigns/${ROOM_ID}/encounters`).push({
                name: document.getElementById('charName').value,
                hp: hp, max_hp: hp, init: 0, type: 'player'
            });
            window.location.href = `sheet.html?room=${ROOM_ID}&id=${charRef.key}`;
        });
    }

    // Run once on load to filter drop downs immediately
    updateRaceInfo();
    updateClassInfo();
</script>
</body>
</html>
