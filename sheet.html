<!DOCTYPE html>
<html>
<head>
    <title>Character Sheet</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="config.js"></script>
    <script src="game_rules.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #1a1a1a; color: #eee; margin: 0; padding: 20px; display:flex; flex-direction:column; height:100vh; box-sizing:border-box;}
        header { background: #252525; padding: 15px 20px; border-bottom: 2px solid #444; display:flex; justify-content:space-between; align-items:center; box-shadow: 0 4px 6px rgba(0,0,0,0.3); z-index: 10; flex-shrink: 0; }
        .char-identity h1 { margin:0; color: #fff; font-size: 1.6em; line-height: 1em; }
        .char-identity .sub { color: #8af; font-size: 0.8em; font-weight: bold; }
        .combat-stats { display: flex; align-items: center; gap: 15px; }
        .stat-badge { text-align:center; border:2px solid #555; border-radius: 8px; width:70px; background:#333; height: 60px; display:flex; flex-direction:column; justify-content:center; position:relative;}
        .stat-val { font-size:1.4em; font-weight:bold; color:#fff; line-height: 1em; }
        .stat-label { font-size:0.65em; color:#aaa; text-transform: uppercase; letter-spacing: 1px; }
        .hp-input { background:transparent; border:none; color:#4f4; font-size:1em; font-weight:bold; width:100%; text-align:center; cursor:pointer; }
        
        .level-badge { position:absolute; top:-10px; right:-10px; background:#e51e25; color:white; border-radius:50%; width:25px; height:25px; font-size:0.8em; font-weight:bold; line-height:25px; text-align:center; box-shadow:0 2px 4px rgba(0,0,0,0.5); }
        
        .tab-nav { display: flex; background: #1f1f1f; border-bottom: 1px solid #444; flex-shrink: 0; }
        .tab-btn { flex: 1; background: transparent; border: none; color: #888; padding: 15px; font-size: 1em; cursor: pointer; font-weight: bold; border-bottom: 3px solid transparent; transition: 0.2s; }
        .tab-btn.active { color: #e51e25; border-bottom-color: #e51e25; background: #252525; }
        .content-area { flex: 1; overflow-y: auto; padding: 20px; position: relative; }
        .tab-pane { display: none; max-width: 800px; margin: 0 auto; }
        .tab-pane.active { display: block; }

        .card { background: #252525; padding: 12px; margin-bottom: 10px; border-radius: 6px; border: 1px solid #444; position: relative; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .card-feature { border-left: 4px solid #fa8; }
        .card-spell { border-left: 4px solid #8af; }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 5px; }
        .card-title { font-size: 1.1em; font-weight: bold; color: #fff; }
        .card-meta { font-size: 0.8em; color: #aaa; }
        .card-desc { font-size: 0.9em; color: #ccc; font-style: italic; margin-bottom: 10px; padding-left: 8px; border-left: 2px solid #444; }
        
        .roll-btn { width:100%; border: none; padding: 8px; border-radius: 4px; cursor: pointer; font-weight: bold; color: white; font-size: 0.9em; transition: 0.2s; background: #444; color:#d4af37; }
        .btn-hit { background: #2b5fa3; color:white; }
        .btn-dmg { background: #a33; color:white; }
        
        .inv-item { display: flex; justify-content: space-between; align-items: center; background: #2a2a2a; padding: 8px; margin-bottom: 5px; border-radius: 4px; border: 1px solid #333; }
        .btn-equip { background: #444; border: 1px solid #666; color: #aaa; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8em; margin-right: 5px; }
        .btn-equip.equipped { background: #2b5fa3; color: white; border-color: #2b5fa3; }
        .btn-del { color: #f44; cursor: pointer; font-weight: bold; padding: 0 5px; }
        
        .saves-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px; margin-bottom: 20px; }
        .save-box { background: #252525; padding: 8px; border-radius: 4px; text-align: center; border: 1px solid #444; cursor: pointer; }
        .save-val { font-size: 1.2em; font-weight: bold; color: #fff; }
        
        .skill-list { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .skill-btn { background: #252525; padding: 8px 12px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border: 1px solid #333; }
        
        .coin-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #444; }
        .coin-box { text-align: center; background: #222; padding: 5px; border-radius: 4px; }
        .coin-box input { width: 100%; background: transparent; border: none; color: white; text-align: center; font-weight: bold; }
        
        #chat { height: 150px; background: #111; border-top: 2px solid #e51e25; padding: 10px; overflow-y: scroll; font-family: monospace; font-size: 0.9em; flex-shrink: 0; }
        .msg { margin-bottom: 4px; padding: 4px 8px; border-left: 3px solid #555; }
    </style>
</head>
<body>

<header>
    <div class="char-identity">
        <h1 id="charName">...</h1>
        <div id="classDisplay" class="sub">Loading...</div>
    </div>
    <div class="combat-stats">
        <div class="stat-badge">
            <div class="stat-val"><input type="number" id="levelInput" class="hp-input" style="color:white;" onchange="updateLevel()"></div>
            <div class="stat-label">Level</div>
        </div>
        <div class="stat-badge hp-box">
            <div class="stat-val"><input type="number" id="hpInput" class="hp-input" onchange="updateHP()"></div>
            <div class="stat-label">/ <span id="hpMax"></span> HP</div>
        </div>
        <div class="stat-badge">
            <div class="stat-val" id="dispAC">10</div>
            <div class="stat-label">AC</div>
        </div>
        <div class="stat-badge" onclick="rollInit()" style="cursor:pointer; border-color:#e51e25;">
            <div class="stat-val" id="dispInit" style="color:#e51e25;">+0</div>
            <div class="stat-label">Init</div>
        </div>
        <a href="builder.html" id="editLink" style="background:#444; color:white; padding:5px 10px; border-radius:4px; text-decoration:none;">Edit</a>
        <a href="index.html" style="background:#444; color:white; padding:5px 10px; border-radius:4px; text-decoration:none;">Exit</a>
    </div>
</header>

<div class="tab-nav">
    <button class="tab-btn active" onclick="openTab('tab-actions')">Actions</button>
    <button class="tab-btn" onclick="openTab('tab-spells')">Spells</button>
    <button class="tab-btn" onclick="openTab('tab-skills')">Skills</button>
    <button class="tab-btn" onclick="openTab('tab-inv')">Inventory</button>
</div>

<div class="content-area">
    <div id="tab-actions" class="tab-pane active"><div id="attackList"></div></div>
    <div id="tab-spells" class="tab-pane"><div id="spellList"></div></div>
    <div id="tab-skills" class="tab-pane">
        <div class="saves-grid" id="savesList"></div>
        <div class="skill-list" id="skillList"></div>
    </div>
    <div id="tab-inv" class="tab-pane">
        <div class="coin-grid">
            <div class="coin-box"><small style="color:#d4af37">CP</small><input type="number" id="coin_cp" onchange="updateCoins()"></div>
            <div class="coin-box"><small style="color:#d4af37">SP</small><input type="number" id="coin_sp" onchange="updateCoins()"></div>
            <div class="coin-box"><small style="color:#d4af37">EP</small><input type="number" id="coin_ep" onchange="updateCoins()"></div>
            <div class="coin-box"><small style="color:#d4af37">GP</small><input type="number" id="coin_gp" onchange="updateCoins()"></div>
            <div class="coin-box"><small style="color:#d4af37">PP</small><input type="number" id="coin_pp" onchange="updateCoins()"></div>
        </div>
        <input type="text" id="apiSearch" placeholder="Search item..." style="width:100%; padding:8px; background:#222; border:1px solid #444; color:white; margin-bottom:10px;" onkeyup="searchEquipment()">
        <div id="apiResults" style="background:#111; border:1px solid #444; display:none; max-height:150px; overflow-y:auto; margin-bottom:10px;"></div>
        <div id="invList"></div>
    </div>
</div>

<div id="chat"></div>

<script>
    if(typeof ALL_ACTIONS==='undefined') window.ALL_ACTIONS=[];
    const params = new URLSearchParams(window.location.search);
    const ROOM_ID = params.get('room');
    const CHAR_ID = params.get('id');
    if(!ROOM_ID || !CHAR_ID) window.location.href="index.html";
    document.getElementById('editLink').href=`builder.html?room=${ROOM_ID}&id=${CHAR_ID}`;

    let CHAR={}, STATS={}, PROF=2, INIT_BONUS=0;

    db.ref(`campaigns/${ROOM_ID}/characters/${CHAR_ID}`).on('value', snap => {
        if(!snap.exists()) return;
        CHAR = snap.val();
        if(!CHAR.inventory) CHAR.inventory=[];
        if(!CHAR.coins) CHAR.coins={cp:0,sp:0,ep:0,gp:0,pp:0};
        if(!CHAR.level) CHAR.level = 1; // Default to level 1 if new
        renderSheet();
    });

    db.ref(`campaigns/${ROOM_ID}/chat`).limitToLast(10).on('child_added', snap => {
        const d = snap.val();
        const c = document.getElementById('chat');
        c.innerHTML = `<div class="msg"><strong>${d.user}</strong>: ${d.lbl} -> <b>${d.val}</b></div>` + c.innerHTML;
    });

    function renderSheet() {
        document.getElementById('charName').innerText = CHAR.name;
        document.getElementById('classDisplay').innerText = `${CHAR.race} ${CHAR.class}`;
        document.getElementById('hpInput').value = CHAR.hp_curr;
        document.getElementById('hpMax').innerText = CHAR.hp_max;
        document.getElementById('levelInput').value = CHAR.level;

        // Calc Prof
        PROF = 2 + Math.floor((CHAR.level - 1)/4);

        ['STR','DEX','CON','INT','WIS','CHA'].forEach(s => STATS[s] = Math.floor((CHAR.stats[s]-10)/2));
        ['cp','sp','ep','gp','pp'].forEach(c => document.getElementById(`coin_${c}`).value = CHAR.coins[c]||0);

        // AC
        let ac = 10 + STATS['DEX'];
        let shield=0, armor=false;
        CHAR.inventory.forEach(i => {
            if(i.equip) {
                let r = ALL_ACTIONS.find(x=>x.name===i.name);
                if(r && r.category==='Armor') {
                    if(r.armor_type==='Shield') shield+=r.ac;
                    else {
                        armor=true;
                        if(r.armor_type==='Light') ac=r.ac+STATS['DEX'];
                        else if(r.armor_type==='Medium') ac=r.ac+Math.min(STATS['DEX'],2);
                        else if(r.armor_type==='Heavy') ac=r.ac;
                    }
                }
            }
        });
        if(!armor && shield===0) {
            if(CHAR.class==="Monk") ac=10+STATS['DEX']+STATS['WIS'];
            if(CHAR.class==="Barbarian") ac=10+STATS['DEX']+STATS['CON'];
        }
        document.getElementById('dispAC').innerText = ac+shield;
        INIT_BONUS=STATS['DEX'];
        document.getElementById('dispInit').innerText = (INIT_BONUS>=0?"+":"")+INIT_BONUS;

        renderActions();
        renderSkills();
        renderInv();
    }

    function renderActions() {
        const atkDiv = document.getElementById('attackList');
        const spellDiv = document.getElementById('spellList');
        atkDiv.innerHTML=""; spellDiv.innerHTML="";

        // 1. Unarmed
        renderCard({name:"Unarmed Strike", dice:"1", type:"Bludgeoning", stat:"STR"}, atkDiv);

        // 2. Class Features (Based on Level)
        const cls = CLASSES[CHAR.class];
        if(cls && cls.features) {
            cls.features.forEach(f => {
                if(CHAR.level >= f[0]) {
                    let feat = SUBCLASS_FEATURES.find(sf => sf.name === f[1]);
                    if(feat) renderCard(feat, atkDiv);
                }
            });
        }

        // 3. Subclass Features (Requires subclass to be saved in CHAR)
        // Note: The builder doesn't save subclass name yet, but if you edit DB manually:
        // CHAR.subclass = "Drunken Master"
        // It will work.
        // For now, let's assume we implement subclass selection later or just render all if not defined?
        // Let's iterate all known subclasses for this class and check features
        if(cls && cls.subclasses) {
            Object.values(cls.subclasses).forEach(sub => {
                // Ideally check: if (CHAR.subclass === subName)
                sub.features.forEach(f => {
                    if(CHAR.level >= f[0]) {
                        let feat = SUBCLASS_FEATURES.find(sf => sf.name === f[1]);
                        if(feat) renderCard(feat, atkDiv);
                    }
                });
            });
        }

        // 4. Inventory
        CHAR.inventory.forEach(i => {
            let d = ALL_ACTIONS.find(a=>a.name===i.name);
            if(!d) return;
            if(d.category!=='Spell' && d.category!=='Feature' && !i.equip) return;
            if(d.category==='Spell') renderCard(d, spellDiv);
            else renderCard(d, atkDiv);
        });
    }

    function renderCard(data, container) {
        let useStat = data.stat || "STR";
        if(data.category==="Spell") useStat="INT";
        let mod = STATS[useStat]||0;
        let hit = mod + PROF;
        let dmg = (data.dice && data.dice.includes('d')) ? `${data.dice} ${mod>=0?'+':''}${mod}` : data.dice;

        let btns = `<button class="roll-btn" onclick="pushChat('${data.name}', 'Used Feature', '-')">Use Feature</button>`;
        
        if(data.dice && data.dice!=="-") {
             btns = `<div style="display:flex; gap:5px;">
                <button class="roll-btn btn-hit" onclick="rollAtk('${data.name}', ${hit})">Hit +${hit}</button>
                <button class="roll-btn btn-dmg" onclick="rollDmg('${data.name}', '${data.dice}', ${mod})">Dmg ${dmg}</button>
            </div>`;
        }

        container.innerHTML += `
            <div class="card ${data.category==='Feature'?'card-feature':''}">
                <div class="card-header"><span>${data.name}</span><small>${data.category}</small></div>
                <div class="card-desc">${data.desc||''}</div>
                ${btns}
            </div>`;
    }

    function updateLevel() {
        let l = parseInt(document.getElementById('levelInput').value);
        db.ref(`campaigns/${ROOM_ID}/characters/${CHAR_ID}/level`).set(l);
    }

    function renderInv() {
        const div = document.getElementById('invList'); div.innerHTML="";
        CHAR.inventory.forEach((i, idx) => {
            let eq = i.equip?"equipped":"";
            div.innerHTML += `<div class="inv-item">
                <span>${i.name}</span>
                <div>
                    <button class="btn-equip ${eq}" onclick="togEq(${idx})">${i.equip?'Un':''}Equip</button>
                    <button class="btn-del" onclick="delItem(${idx})">x</button>
                </div>
            </div>`;
        });
    }

    // --- UTILS ---
    function togEq(i) { let n=[...CHAR.inventory]; n[i].equip=!n[i].equip; db.ref(`campaigns/${ROOM_ID}/characters/${CHAR_ID}/inventory`).set(n); }
    function delItem(i) { let n=[...CHAR.inventory]; n.splice(i,1); db.ref(`campaigns/${ROOM_ID}/characters/${CHAR_ID}/inventory`).set(n); }
    function updateHP() { db.ref(`campaigns/${ROOM_ID}/characters/${CHAR_ID}/hp_curr`).set(parseInt(document.getElementById('hpInput').value)); }
    function updateCoins() { /* ... same as before ... */ }
    function rollAtk(n,m) { const r=Math.floor(Math.random()*20)+1; pushChat(`Atk ${n}`, r+m, `${r}+${m}`, r===20); }
    function rollDmg(n,d,m) { /* ... same as before ... */ pushChat(`Dmg ${n}`, "Roll", d); }
    function pushChat(l,v,f,c=false) { db.ref(`campaigns/${ROOM_ID}/chat`).push({user:CHAR.name, lbl:l, val:v, formula:f, nat20:c}); }
    
    // Search
    let st;
    function searchEquipment() {
        clearTimeout(st);
        const q = document.getElementById('apiSearch').value.toLowerCase();
        const res = document.getElementById('apiResults');
        if(q.length<2) { res.style.display='none'; return; }
        st = setTimeout(() => {
            res.innerHTML=""; res.style.display='block';
            let hits = ALL_ACTIONS.filter(a=>a.name.toLowerCase().includes(q));
            hits.slice(0,5).forEach(h => {
                res.innerHTML += `<div style="padding:5px; cursor:pointer; border-bottom:1px solid #333;" onclick="addItem('${h.name}')">${h.name}</div>`;
            });
        }, 300);
    }
    function addItem(n) {
        let inv = CHAR.inventory||[]; inv.push({name:n, equip:false});
        db.ref(`campaigns/${ROOM_ID}/characters/${CHAR_ID}/inventory`).set(inv);
        document.getElementById('apiResults').style.display='none';
        document.getElementById('apiSearch').value='';
    }
    function renderSkills() { /* ... same as before ... */ }
    function rollCheck(l,m) { const r=Math.floor(Math.random()*20)+1; pushChat(l, r+m, `${r}+${m}`); }
    function openTab(id) { document.querySelectorAll('.tab-pane').forEach(e=>e.style.display='none'); document.getElementById(id).style.display='block'; }
</script>
</body>
</html>
