<!DOCTYPE html>
<html>
<head>
    <title>Character Builder</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="config.js"></script>
    <script src="game_rules.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #121212; color: #eee; margin: 0; padding: 20px; display: flex; justify-content: center; min-height: 100vh; }
        .builder-container { max-width: 650px; width: 100%; background: #1e1e1e; padding: 30px; border-radius: 8px; border: 1px solid #333; display: flex; flex-direction: column; }
        
        h1 { color: #e51e25; border-bottom: 1px solid #333; padding-bottom: 10px; margin-top: 0; text-align: center; }
        
        /* STEPS */
        .step { display: none; animation: fadeIn 0.3s; }
        .step.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* INPUTS */
        label { display: block; color: #8af; font-weight: bold; margin-bottom: 5px; margin-top: 15px; font-size: 0.9em; }
        input, select, textarea { width: 100%; padding: 12px; background: #2a2a2a; border: 1px solid #444; color: white; border-radius: 4px; box-sizing: border-box; font-size: 1em; }
        input:focus, select:focus { border-color: #e51e25; outline: none; }
        
        /* STAT GRID */
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }
        .stat-box { text-align: center; background: #252525; padding: 10px; border-radius: 4px; border: 1px solid #333; }
        .stat-box label { margin: 0 0 5px 0; color: #aaa; }
        .stat-box select { text-align: center; font-weight: bold; font-size: 1.1em; background: #1a1a1a; padding: 5px; cursor:pointer; color: #fff; }
        .bonus-badge { font-size: 0.8em; color: #4f4; display: block; height: 1.2em; margin-top: 5px; }
        
        /* RP GRID */
        .rp-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }

        /* SKILLS */
        .auto-skill { background: #2a7a3a; color: white; padding: 5px 10px; border-radius: 4px; margin-bottom: 5px; display: inline-block; font-size: 0.9em; }
        .skill-select-group { margin-bottom: 10px; }

        /* EQUIPMENT TOGGLE */
        .equip-toggle { display: flex; gap: 10px; margin-bottom: 15px; }
        .equip-opt { flex: 1; padding: 10px; border: 1px solid #444; text-align: center; cursor: pointer; background: #222; border-radius: 4px; }
        .equip-opt.selected { background: #e51e25; color: white; border-color: #e51e25; }

        /* NAV */
        .nav-btns { margin-top: auto; padding-top: 20px; display: flex; justify-content: space-between; border-top: 1px solid #333; }
        .btn { padding: 12px 25px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 1em; transition: 0.2s; }
        .btn-next { background: #e51e25; color: white; } .btn-next:hover { background: #ff3b3b; }
        .btn-prev { background: #444; color: white; } .btn-prev:hover { background: #555; }
        
        .summary-box { background: #252525; padding: 10px; border-radius: 4px; font-size: 0.9em; color: #ccc; margin-top: 5px; }
    </style>
</head>
<body>

<div class="builder-container">
    <h1 id="headerTitle">Basic Info</h1>
    
    <div id="step1" class="step active">
        <label>Character Name</label>
        <input type="text" id="charName" placeholder="e.g. Valeros">
        
        <label>Race</label>
        <select id="charRace" onchange="updateRaceInfo()"></select>
        <div id="raceSummary" class="summary-box"></div>

        <label>Class</label>
        <select id="charClass" onchange="updateClassInfo()"></select>
        <div id="classSummary" class="summary-box"></div>
    </div>

    <div id="step2" class="step">
        <div style="text-align:center; color:#888; margin-bottom:15px; font-size:0.9em;">
            Assign Standard Array: 15, 14, 13, 12, 10, 8
        </div>
        <div class="stat-grid">
            <div class="stat-box"><label>STR</label><select id="base_STR" onchange="updateStatOptions()"></select><span id="bon_STR" class="bonus-badge"></span></div>
            <div class="stat-box"><label>DEX</label><select id="base_DEX" onchange="updateStatOptions()"></select><span id="bon_DEX" class="bonus-badge"></span></div>
            <div class="stat-box"><label>CON</label><select id="base_CON" onchange="updateStatOptions()"></select><span id="bon_CON" class="bonus-badge"></span></div>
            <div class="stat-box"><label>INT</label><select id="base_INT" onchange="updateStatOptions()"></select><span id="bon_INT" class="bonus-badge"></span></div>
            <div class="stat-box"><label>WIS</label><select id="base_WIS" onchange="updateStatOptions()"></select><span id="bon_WIS" class="bonus-badge"></span></div>
            <div class="stat-box"><label>CHA</label><select id="base_CHA" onchange="updateStatOptions()"></select><span id="bon_CHA" class="bonus-badge"></span></div>
        </div>
        <div class="summary-box" style="margin-top:20px; text-align:center;">
            <strong>Starting HP:</strong> <span id="calcHP" style="color:#4f4; font-weight:bold;"></span>
        </div>
    </div>

    <div id="step3" class="step">
        <label>Racial Skills (Auto-Added)</label>
        <div id="racialSkillsArea"></div>
        
        <label>Class Skills (Choose <span id="skillCount">2</span>)</label>
        <div id="skillSelectArea"></div>
    </div>

    <div id="step4" class="step">
        <div id="equipSectionWrapper">
            <label>Starting Equipment</label>
            <div class="equip-toggle">
                <div class="equip-opt selected" id="optLoadout" onclick="setEquipMode('loadout')">Class Loadout</div>
                <div class="equip-opt" id="optGold" onclick="setEquipMode('gold')">Starting Gold</div>
            </div>

            <div id="loadoutSection">
                <div class="summary-box" id="classGearList"></div>
                <label>Add Tool / Kit</label>
                <select id="toolSelect"></select>
            </div>

            <div id="goldSection" style="display:none;">
                <label>Starting Gold Pieces (GP)</label>
                <input type="number" id="startGold" value="100">
                <div style="font-size:0.8em; color:#888; margin-top:5px;">Your inventory will start empty.</div>
            </div>
        </div>
        <div id="editModeNotice" style="display:none; color:#d4af37; text-align:center; margin-top:10px;">
            (Inventory is preserved when editing. To reset gear, delete character and recreate.)
        </div>

        <label>Roleplay Details</label>
        <select id="charAlign">
            <option value="True Neutral">Alignment...</option>
            <option value="Lawful Good">Lawful Good</option>
            <option value="Neutral Good">Neutral Good</option>
            <option value="Chaotic Good">Chaotic Good</option>
            <option value="Lawful Neutral">Lawful Neutral</option>
            <option value="True Neutral">True Neutral</option>
            <option value="Chaotic Neutral">Chaotic Neutral</option>
            <option value="Lawful Evil">Lawful Evil</option>
            <option value="Neutral Evil">Neutral Evil</option>
            <option value="Chaotic Evil">Chaotic Evil</option>
        </select>

        <div class="rp-grid" style="margin-top:10px;">
            <input type="text" id="rpAge" placeholder="Age">
            <input type="text" id="rpHeight" placeholder="Height">
            <input type="text" id="rpWeight" placeholder="Weight">
        </div>
        <div class="rp-grid" style="margin-top:10px;">
            <input type="text" id="rpEyes" placeholder="Eyes">
            <input type="text" id="rpHair" placeholder="Hair">
            <input type="text" id="rpSkin" placeholder="Skin">
        </div>
        
        <textarea id="charBack" rows="3" placeholder="Backstory / Notes" style="margin-top:10px;"></textarea>
    </div>

    <div class="nav-btns">
        <button class="btn btn-prev" onclick="changeStep(-1)" id="btnPrev" style="visibility:hidden;">Back</button>
        <button class="btn btn-next" onclick="changeStep(1)" id="btnNext">Next</button>
    </div>
</div>

<script>
    // --- SETUP ---
    const params = new URLSearchParams(window.location.search);
    const ROOM_ID = params.get('room');
    const EDIT_ID = params.get('id');
    if(!ROOM_ID) window.location.href = "index.html";

    let currentStep = 1;
    const totalSteps = 4;
    const STAT_KEYS = ['STR','DEX','CON','INT','WIS','CHA'];
    const STANDARD_ARRAY = [15, 14, 13, 12, 10, 8];
    const TOOLS_LIST = ["None", "Thieves' Tools", "Smith's Tools", "Brewer's Supplies", "Mason's Tools", "Herbalism Kit", "Navigator's Tools", "Disguise Kit", "Poisoner's Kit", "Musical Instrument"];
    let equipMode = 'loadout';

    // --- POPULATION ---
    const raceSel = document.getElementById('charRace');
    Object.keys(RACES).sort().forEach(r => raceSel.add(new Option(r,r)));
    const classSel = document.getElementById('charClass');
    Object.keys(CLASSES).sort().forEach(c => classSel.add(new Option(c,c)));
    
    // Tools
    const toolSel = document.getElementById('toolSelect');
    TOOLS_LIST.forEach(t => toolSel.add(new Option(t,t)));

    // Stats Init
    STAT_KEYS.forEach(s => {
        let sel = document.getElementById(`base_${s}`);
        sel.add(new Option("--", ""));
        STANDARD_ARRAY.forEach(n => sel.add(new Option(n, n)));
    });

    // --- LOAD DATA IF EDITING ---
    if(EDIT_ID) {
        document.getElementById('headerTitle').innerText = "Edit Character";
        // Hide Equipment Selector when editing (preserve existing)
        document.getElementById('equipSectionWrapper').style.display = 'none';
        document.getElementById('editModeNotice').style.display = 'block';

        db.ref(`campaigns/${ROOM_ID}/characters/${EDIT_ID}`).once('value', snap => {
            if(snap.exists()) {
                const c = snap.val();
                document.getElementById('charName').value = c.name;
                raceSel.value = c.race;
                classSel.value = c.class;
                
                if(c.base_stats) {
                    STAT_KEYS.forEach(s => document.getElementById(`base_${s}`).value = c.base_stats[s]);
                }
                
                // RP
                document.getElementById('charAlign').value = c.alignment || "True Neutral";
                document.getElementById('charBack').value = c.backstory || "";
                ['Age','Height','Weight','Eyes','Hair','Skin'].forEach(f => {
                    document.getElementById(`rp${f}`).value = c[f.toLowerCase()] || "";
                });

                updateRaceInfo(); updateClassInfo(); updateStatOptions();
            }
        });
    } else {
        updateRaceInfo(); updateClassInfo(); updateStatOptions();
    }

    // --- LOGIC ---
    function updateStatOptions() {
        STAT_KEYS.forEach(s => {
            let sel = document.getElementById(`base_${s}`);
            let val = parseInt(sel.value);
            sel.innerHTML = "";
            sel.add(new Option("--", ""));
            if(!isNaN(val)) sel.add(new Option(val, val, true, true));
            STANDARD_ARRAY.forEach(num => {
                let taken = false;
                STAT_KEYS.forEach(k => { if(k!==s && parseInt(document.getElementById(`base_${k}`).value)===num) taken=true; });
                if(!taken && num !== val) sel.add(new Option(num, num));
            });
        });
        calcStats();
    }

    function updateRaceInfo() {
        const r = RACES[raceSel.value];
        let txt = "Bonuses: "; for(let s in r.bonuses) txt+=`${s} +${r.bonuses[s]} `;
        document.getElementById('raceSummary').innerText = txt;
        calcStats();
    }

    function updateClassInfo() {
        const c = CLASSES[classSel.value];
        document.getElementById('classSummary').innerText = `HP: d${c.hit_die} | Saves: ${c.saves.join(', ')}`;
        
        let gear = [...(c.items || c.starting_gear || []), "Rations", "Waterskin"];
        document.getElementById('classGearList').innerText = gear.join(", ");
        
        calcStats();
        renderSkills();
    }

    function calcStats() {
        const rData = RACES[raceSel.value];
        const cData = CLASSES[classSel.value];
        let conTotal = 10;
        STAT_KEYS.forEach(s => {
            let base = parseInt(document.getElementById(`base_${s}`).value)||0;
            let bonus = (rData.bonuses && rData.bonuses[s]) ? rData.bonuses[s] : 0;
            document.getElementById(`bon_${s}`).innerText = bonus>0?`+${bonus}`:"";
            if(s==='CON') conTotal = base+bonus;
        });
        let conMod = Math.floor((conTotal-10)/2);
        document.getElementById('calcHP').innerText = cData.hit_die + conMod + (rData.hp_bonus||0);
    }

    function renderSkillSelectors() {
        const c = CLASSES[classSel.value];
        const r = RACES[raceSel.value];
        
        // Race Skills
        const rArea = document.getElementById('racialSkillsArea');
        rArea.innerHTML = "";
        (r.skills || []).forEach(s => rArea.innerHTML += `<div class="auto-skill">${s}</div>`);
        if(!(r.skills || []).length) rArea.innerHTML = "<span style='color:#555;'>None</span>";

        // Class Skills
        const cArea = document.getElementById('skillSelectArea');
        cArea.innerHTML = "";
        let count = c.num_skills || 2;
        if(classSel.value==="Rogue") count=4; if(classSel.value==="Bard"||classSel.value==="Ranger") count=3;
        document.getElementById('skillCount').innerText = count;
        
        let opts = c.skill_options || Object.keys(SKILLS_LIST);
        for(let i=0; i<count; i++) {
            let sel = document.createElement('select');
            sel.className = "skill-select";
            sel.style.marginBottom = "10px";
            opts.forEach(sk => {
                if(!(r.skills||[]).includes(sk)) sel.add(new Option(sk, sk));
            });
            cArea.appendChild(sel);
        }
    }

    function setEquipMode(mode) {
        equipMode = mode;
        if(mode === 'loadout') {
            document.getElementById('optLoadout').className = 'equip-opt selected';
            document.getElementById('optGold').className = 'equip-opt';
            document.getElementById('loadoutSection').style.display = 'block';
            document.getElementById('goldSection').style.display = 'none';
        } else {
            document.getElementById('optLoadout').className = 'equip-opt';
            document.getElementById('optGold').className = 'equip-opt selected';
            document.getElementById('loadoutSection').style.display = 'none';
            document.getElementById('goldSection').style.display = 'block';
        }
    }

    // --- NAV ---
    function changeStep(dir) {
        if(currentStep === 1 && dir === 1 && !document.getElementById('charName').value) return alert("Name required.");
        if(currentStep === 2 && dir === 1) {
            let allFilled = true;
            STAT_KEYS.forEach(s => { if(document.getElementById(`base_${s}`).value === "") allFilled=false; });
            if(!allFilled) return alert("Select all ability scores.");
        }

        document.getElementById(`step${currentStep}`).classList.remove('active');
        currentStep += dir;
        
        if(currentStep > totalSteps) { save(); return; }
        
        document.getElementById(`step${currentStep}`).classList.add('active');
        document.getElementById('btnPrev').style.visibility = (currentStep === 1) ? 'hidden' : 'visible';
        document.getElementById('btnNext').innerText = (currentStep === totalSteps) ? (EDIT_ID?'Update':'Create') : 'Next';
        
        const titles = ["", "Identity", "Ability Scores", "Skills", "Finalize"];
        document.getElementById('headerTitle').innerText = titles[currentStep];
    }

    function save() {
        document.getElementById('btnNext').innerText = "Saving...";
        document.getElementById('btnNext').disabled = true;

        const rData = RACES[raceSel.value];
        const cData = CLASSES[classSel.value];
        
        let baseStats = {};
        let finalStats = {};
        STAT_KEYS.forEach(s => {
            let b = parseInt(document.getElementById(`base_${s}`).value);
            let bon = (rData.bonuses && rData.bonuses[s]) ? rData.bonuses[s] : 0;
            baseStats[s] = b;
            finalStats[s] = b + bon;
        });

        let conMod = Math.floor((finalStats['CON']-10)/2);
        let hp = cData.hit_die + conMod + (rData.hp_bonus||0);

        let skills = [...(rData.skills||[])];
        document.querySelectorAll('.skill-select').forEach(s => {
            if(!skills.includes(s.value)) skills.push(s.value);
        });

        let data = {
            name: document.getElementById('charName').value,
            race: raceSel.value,
            class: classSel.value,
            base_stats: baseStats,
            stats: finalStats,
            hp_max: hp,
            alignment: document.getElementById('charAlign').value,
            backstory: document.getElementById('charBack').value,
            age: document.getElementById('rpAge').value,
            height: document.getElementById('rpHeight').value,
            weight: document.getElementById('rpWeight').value,
            eyes: document.getElementById('rpEyes').value,
            hair: document.getElementById('rpHair').value,
            skin: document.getElementById('rpSkin').value,
            skills: skills
        };

        if(!EDIT_ID) {
            // Inventory Logic (Only on create)
            data.hp_curr = hp;
            data.slots_used = {};
            data.charges = {};
            
            let items = [];
            let coins = {cp:0, sp:0, ep:0, gp:0, pp:0};
            
            if(equipMode === 'loadout') {
                items = [...(cData.items || cData.starting_gear || []), "Rations", "Waterskin"];
                let tool = document.getElementById('toolSelect').value;
                if(tool !== "None") items.push(tool);
                coins.gp = 10; 
            } else {
                coins.gp = parseInt(document.getElementById('startGold').value) || 0;
            }
            
            // Auto Spells
            let spells = [...(rData.auto_spells||[]), ...(cData.auto_spells||[])];
            spells.forEach(s => items.push(s));
            
            data.inventory = items.map(i => ({name: i, equip: false})); // Correct format
            data.coins = coins;
        }

        const ref = EDIT_ID ? db.ref(`campaigns/${ROOM_ID}/characters/${EDIT_ID}`) : db.ref(`campaigns/${ROOM_ID}/characters`).push();
        
        (EDIT_ID ? ref.update(data) : ref.set(data)).then(() => {
            if(!EDIT_ID) {
                // Add to tracker
                db.ref(`campaigns/${ROOM_ID}/encounters`).push({
                    name: data.name, hp: hp, max_hp: hp, init: 0, type: 'player'
                });
            }
            window.location.href = `sheet.html?room=${ROOM_ID}&id=${ref.key || EDIT_ID}`;
        });
    }
</script>
</body>
</html>
